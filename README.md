# NXFLAT Toolchain

*NOTE:* This work is forked off from the NuttX buildroot repository at https://bitbucket.org/nuttx/buildroot to build as standalone applications.  This project is primarily the work of Gregory Nutt.

NXFLAT is a customized and simplified version of binary format implemented a few years ago called XFLAT With the NXFLAT binary format you will be able to do the following:

 * Place separately linked programs in a file system, and
 * Execute those programs by dynamically linking them to the base NuttX code.

This allows you to extend the NuttX base code after it has been written into FLASH. One motivation for implementing NXFLAT is support clean CGI under an HTTPD server.

This feature is especially attractive when combined with the NuttX ROMFS support: ROMFS allows you to execute programs in place (XIP) in flash without copying anything other than the .data section to RAM. In fact, the initial NXFLAT release only worked on ROMFS. Later extensions also support execution NXFLAT binaries from an SRAM copy as well.

This NuttX feature includes:

 * A dynamic loader that is built into the NuttX core (See GIT).
 * Minor changes to RTOS to support position independent code, and
 * A linker to bind ELF binaries to produce the NXFLAT binary format (See GIT).

## Background

NXFLAT is derived from XFLAT. XFLAT is a toolchain add that provides full shared library and XIP executable support for processors that have no Memory Management Unit (MMU). NXFLAT is greatly simplified for the deeply embedded environment targeted by NuttX:

 * NXFLAT does not support shared libraries, because
 * NXFLAT does not support exportation of symbol values from a module

Rather, the NXFLAT module only imports symbol values. In the NXFLAT model, the (PIC) NXFLAT module resides in a FLASH file system and when it is loaded at run time, it is dynamically linked only to the (non-PIC) base NuttX code: The base NuttX exports a symbol table; the NXFLAT module imports those symbol value to dynamically bind the module to the base code. 

## Programs

### mknxflat

Is used to build a thunk file. See below for usage.

```
    Usage: mknxflat [options] <bfd-filename>

    Where options are one or more of the following.  Note
    that a space is always required between the option and
    any following arguments.

      -d Use dynamic symbol table. [symtab]
      -f <cmd-filename>
          Take next commands from <cmd-filename> [cmd-line]
      -o <out-filename>
         Output to  [stdout]
      -v Verbose output [no output]
      -w Import weakly declared functions, i.e., weakly
         declared functions are expected to be provided at
         load-time [not imported]
```

### ldnxflat

ldnxflat is use to link your object files along with the thunk file generated by mknxflat to produce the NXFLAT binary module. See below for usage.

```
    Usage: ldnxflat [options] <bfd-filename>

    Where options are one or more of the following.  Note
    that a space is always required between the option and
    any following arguments.

      -d Use dynamic symbol table [Default: symtab]
      -e <entry-point>
         Entry point to module [Default: _start]
      -o <out-filename>
         Output to <out-filename> [Default: <bfd-filename>.nxf]
      -s <stack-size>
         Set stack size to <stack-size> [Default: 4096]
      -v Verbose output. If -v is applied twice, additional
         debug output is enabled [Default: no verbose output].
```

### readnxflat

readnxflat is used for dumping information from nxflat files.

```
   Usage: ./readnxflat [options] <flat-filename>

   Where options are one or more of the following:

     -h Dump the XFLAT file header     [not dumped]
     -r Dump relocation entries        [not dumped]
     -i Dump the imported symbol table [not dumped]
     -x Dump xFLT loader pathname      [not dumped]
     -c Disassemble the text section   [not dumped]
     -d Dump data section (hex)        [not dumped]
     -a Dump all of the above          [not dumped]
     -b Assume big-endian byteorder    [little endian]
     -v Output verbose debug info      [no output]
```

## Building

This project depends on libbfd which is bundled as part of GNU Binutils.  For building the development files are needs, they are frequently packaged as `binutils-devel` or `binutils-dev`.

These tools can be built for `arm` or `thumb2` by setting the ARCH variable, by default thumb2 will be used.

```
❯ make
cc -c -Wall -I. -o ldnxflat.o ldnxflat.c
cc  ldnxflat.o -o ldnxflat -lbfd
cc -c -Wall -I. -o mknxflat.o mknxflat.c
cc  mknxflat.o -o mknxflat -lbfd
cc -c -Wall -I. -o readnxflat.o readnxflat.c
make -C arch CC="cc"
make[1]: Entering directory '/home/bashton/nuttx/nxflat/thumb2'
cc -c -Wall -o disthumb2.o disthumb2.c
ar rcs libarch.a disthumb2.o
make[1]: Leaving directory '/home/bashton/nuttx/nxflat/thumb2'
cc  -L arch -o readnxflat readnxflat.o -lbfd -larch
```

or

```
❯ ARCH=arm make
cc -c -Wall -I. -o ldnxflat.o ldnxflat.c
cc  ldnxflat.o -o ldnxflat -lbfd
cc -c -Wall -I. -o mknxflat.o mknxflat.c
cc  mknxflat.o -o mknxflat -lbfd
cc -c -Wall -I. -o readnxflat.o readnxflat.c
make -C arch CC="cc"
make[1]: Entering directory '/home/bashton/nuttx/nxflat/arm'
cc -c -Wall -o disarm.o disarm.c
ar rcs libarch.a disarm.o
make[1]: Leaving directory '/home/bashton/nuttx/nxflat/arm'
cc  -L arch -o readnxflat readnxflat.o -lbfd -larch
```

Cleaning:

```
❯ make clean
make -C arch clean
make[1]: Entering directory '/home/bashton/nuttx/nxflat/arm'
rm -f *.o *.a *~ .*.swp core
make[1]: Leaving directory '/home/bashton/nuttx/nxflat/arm'
```
